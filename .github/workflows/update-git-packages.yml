name: Update Git Packages

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      package:
        description: 'Specific package to update (optional, leave empty for all git packages)'
        required: false
        type: string

env:
  AUR_USERNAME: ${{ secrets.AUR_USERNAME }}
  AUR_SSH_PRIVATE_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
  GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

jobs:
  find-packages:
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.get-packages.outputs.packages }}
      package_dirs: ${{ steps.get-packages.outputs.package_dirs }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get git packages
        id: get-packages
        run: |
          if [ "${{ github.event.inputs.package }}" != "" ]; then
            # Use specific package if provided
            PACKAGES='["${{ github.event.inputs.package }}"]'
            PACKAGE_DIRS='["${{ github.event.inputs.package }}"]'
          else
            # Find all directories that end with -git and extract pkgname from PKGBUILD
            PACKAGES=$(find . -maxdepth 1 -type d -name "*-git" | while read dir; do
              if [ -f "$dir/PKGBUILD" ]; then
                if grep -q "^url=.*github\.com" "$dir/PKGBUILD" 2>/dev/null; then
                  # Extract pkgname from PKGBUILD
                  PKGNAME=$(grep "^pkgname=" "$dir/PKGBUILD" | sed 's/pkgname=//' | tr -d '"' | tr -d "'")
                  echo "$PKGNAME"
                fi
              fi
            done | jq -R -s -c 'split("\n")[:-1]')
          fi
          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
          echo "Found packages: $PACKAGES"

  update-git-packages:
    needs: find-packages
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.find-packages.outputs.packages) }}
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

      - name: Cache Docker layers
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Setup SSH for AUR
        if: env.AUR_USERNAME != ''
        run: |
          mkdir -p ~/.ssh
          echo "$AUR_SSH_PRIVATE_KEY" > ~/.ssh/aur_key
          chmod 600 ~/.ssh/aur_key
          ssh-keyscan aur.archlinux.org >> ~/.ssh/known_hosts
          cat >> ~/.ssh/config << EOF
          Host aur.archlinux.org
            IdentityFile ~/.ssh/aur_key
            User $AUR_USERNAME
          EOF

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug Docker Permissions
        run: |
          whoami
          id
          groups
          ls -la /var/run/docker.sock
          docker version
          docker info

      - name: Update git package
        id: update-git-package
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PKG="${{ matrix.package }}"

          if [ ! -d "$PKG" ]; then
            echo "Package directory $PKG not found, skipping..."
            exit 0
          fi

          echo "Building and updating $PKG..."

          # Clone the AUR repository first
          git clone ssh://aur@aur.archlinux.org/$PKG.git $PKG-aur
          cd $PKG-aur

          # Save the current pkgver before any updates
          ORIGINAL_PKGVER=$(grep "^pkgver=" PKGBUILD | sed 's/pkgver=//' | cut -d' ' -f1)
          echo "Original pkgver: $ORIGINAL_PKGVER"

          echo "Running makepkg --nobuild in container..."
          CONTAINER_ID=$(docker run -d -v $(pwd):/home/builder brianrobt/archlinux-aur-dev:latest bash -c "
            yay -S --noconfirm pacman-contrib
            makepkg --nobuild
          ")

          echo "Waiting for container to finish..."
          EXIT_CODE=$(docker wait $CONTAINER_ID)
          echo "Container exited with code: $EXIT_CODE"

          if [ "$EXIT_CODE" != "0" ]; then
            echo "Container failed with exit code $EXIT_CODE"
            echo "Container logs:"
            if ! docker logs $CONTAINER_ID; then
              echo "ERROR: Failed to retrieve container logs for container $CONTAINER_ID"
              echo "This could indicate the container was removed or the logs are inaccessible"
              echo "Attempting to get container status..."
              if docker ps -a --filter "id=$CONTAINER_ID" --format "table {{.ID}}\t{{.Status}}\t{{.Names}}" 2>/dev/null; then
                echo "Container status retrieved successfully"
              else
                echo "ERROR: Could not retrieve container status either"
              fi
            else
              echo "Container logs retrieved successfully!"
            fi
            docker rm $CONTAINER_ID
            exit 1
          fi

          echo "Copying updated PKGBUILD from container..."
          docker cp $CONTAINER_ID:/home/builder/PKGBUILD ./PKGBUILD

          echo "Cleaning up container..."
          docker rm $CONTAINER_ID

          echo "Getting updated pkgver after makepkg --nobuild..."
          UPDATED_PKGVER=$(grep "^pkgver=" PKGBUILD | sed 's/pkgver=//' | cut -d' ' -f1)
          echo "Updated pkgver: $UPDATED_PKGVER"

          echo "Comparing versions..."
          if [ "$ORIGINAL_PKGVER" != "$UPDATED_PKGVER" ]; then
            echo "Version changed from $ORIGINAL_PKGVER to $UPDATED_PKGVER"
            echo "version_changed=true" >> $GITHUB_OUTPUT
          else
            echo "Version unchanged: $ORIGINAL_PKGVER"
            echo "version_changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          cd ..

          echo "Running scripts/run_docker.sh..."
          scripts/run_docker.sh --user "Brian Thompson" --email "brianrobt@pm.me" $PKG

          cd $PKG-aur

          echo "Checking if PKGBUILD or .SRCINFO have changes..."
          if git diff --quiet PKGBUILD .SRCINFO 2>/dev/null; then
            echo "No changes detected in PKGBUILD or .SRCINFO"
          else
            echo "Changes detected in PKGBUILD or .SRCINFO:"
            git diff --name-only PKGBUILD .SRCINFO 2>/dev/null || true

            echo "Adding PKGBUILD and .SRCINFO files..."
            git add PKGBUILD .SRCINFO

            echo "Getting pkgver value..."
            PKGVER=$(grep "^pkgver=" PKGBUILD | sed 's/pkgver=//' | cut -d' ' -f1)

            echo "Getting pkgrel value..."
            PKGREL=$(grep "^pkgrel=" PKGBUILD | sed 's/pkgrel=//')

            PKGVERREL="$PKGVER-$PKGREL"

            echo "Running git commit with message: 'build: release $PKG v$PKGVERREL'..."
            git commit -m "build: release $PKG v$PKGVERREL"
            git push origin master

            echo "Copying PKGBUILD and .SRCINFO files to $PKG directory..."
            cp PKGBUILD ../$PKG/PKGBUILD
            cp .SRCINFO ../$PKG/.SRCINFO

            cd ..

            echo "Adding and committing all files to git..."
            git add -A
            git commit -m "build: release $PKG v$PKGVERREL"
            git push origin master

            echo "pushed=true" >> $GITHUB_OUTPUT
          fi

          echo "Updated $PKG"

      - name: Create summary
        if: always()
        run: |
          echo "## Git Package Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package:** ${{ matrix.package }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if version changed during makepkg --nobuild
          if [ "${{ steps.update-git-package.outputs.version_changed }}" == "true" ]; then
            echo "**Version Check:** 🔄 Version updated by makepkg --nobuild" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Version Check:** ⏭️ No version change detected" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if changes were actually pushed
          if [ "${{ steps.update-git-package.outputs.pushed }}" == "true" ]; then
            echo "**Status:** ✅ Updated" >> $GITHUB_STEP_SUMMARY
            echo "Changes were detected and pushed to both this repository and AUR." >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** ⏭️ No changes" >> $GITHUB_STEP_SUMMARY
            echo "No changes detected in PKGBUILD or .SRCINFO files." >> $GITHUB_STEP_SUMMARY
          fi